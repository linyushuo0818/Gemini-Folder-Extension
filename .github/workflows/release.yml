name: Release Packages

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:

jobs:
  build-and-release:
    runs-on: windows-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Build store package
        run: npm run package:store

      - name: Build Firefox package
        run: npm run package:firefox

      - name: Collect release assets
        shell: pwsh
        run: |
          $storeZip = Get-ChildItem -Path release -Recurse -Filter "gemini-project-extension-store.zip" | Sort-Object LastWriteTime -Descending | Select-Object -First 1
          $firefoxZip = Get-ChildItem -Path release -Recurse -Filter "gemini-project-extension-firefox.zip" | Sort-Object LastWriteTime -Descending | Select-Object -First 1
          if (-not $storeZip) { throw "Store zip not found." }
          if (-not $firefoxZip) { throw "Firefox zip not found." }
          New-Item -Path release-assets -ItemType Directory -Force | Out-Null
          Copy-Item $storeZip.FullName release-assets\gemini-project-extension-store.zip -Force
          Copy-Item $firefoxZip.FullName release-assets\gemini-project-extension-firefox.zip -Force

      - name: Upload release assets
        uses: softprops/action-gh-release@v2
        with:
          files: |
            release-assets/gemini-project-extension-store.zip
            release-assets/gemini-project-extension-firefox.zip
